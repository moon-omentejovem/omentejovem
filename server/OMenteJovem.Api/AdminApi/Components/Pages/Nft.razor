@page "/nfts/{id}"
@inject ListNftsService NftService
@inject NavigationManager Navigation

@using System.ComponentModel.DataAnnotations
@using AdminApi.Components.Pages.Forms
@using AdminApi.Mappers
@using AdminApi.Models
@using AdminApi.Models.Forms
@using AdminApi.Services
@using Domain.Models
@using Microsoft.AspNetCore.Components.Forms
@using MongoDB.Bson

<div>
    <ConfirmDialog @ref="dialog" />
    <Button Color="ButtonColor.Danger" @onclick="DeleteNft">
        <Icon Name="IconName.Trash" />
    </Button>
</div>

<Tabs>
    <Tab Title="NFT Details" IsActive="true">
        <Content>
            <NftDetailsForm NftArtModel="@NftArtModel" NftArtModelChanged="HandleValidSubmit" />
        </Content>
    </Tab>
    <Tab Title="Media">
        <Content>
            <NftMediaForm NftArtModel="@NftArtModel" NftArtId="@Id" NftArtImageSource="@NftArtModel.NftUrl" NftImageUrlChanged="HandleMediaSubmit" />
        </Content>
    </Tab>
    <Tab Title="Owners">
        <Content>
            <NftOwnersForm NftArtModel="@NftArtModel" NftArtModelChanged="HandleOwnersValidSubmit" />
        </Content>
    </Tab>
    <Tab Title="Available Purchase">
        <Content>
            <ExternalLinksForm NftArtForm="@NftArtModel" ExternalLinksChanged="HandleExternalLinksSubmit" />
        </Content>
    </Tab>
    <Tab Title="Mint Event">
        <Content>
            <MintedEventForm NftArtForm="@NftArtModel" MintedEventChanged="HandleMintedEventValidSubmit" />
        </Content>
    </Tab>
</Tabs>

@code {
    [Parameter]
    public string Id { get; set; }

    private NftArtForm NftArtModel = new();
    private LinksForm LinksForm = new();

    private NftArt? DomainNft;

    private ConfirmDialog dialog;

    protected override async Task OnInitializedAsync()
    {
        DomainNft = await NftService.GetNft(ObjectId.Parse(Id));

        NftArtModel = FormMapper.FromDomain(DomainNft);
        LinksForm = FormMapper.FromDomain(DomainNft.ExternalLinks);
    }

    private async Task HandleValidSubmit()
    {
        await NftService.UpdateNft(new UpdateNftBuilder(DomainNft!.Id)
            .Set(n => n.Name, NftArtModel.Name)
            .Set(n => n.Description, NftArtModel.Description)
            .Set(n => n.CreatedAt, NftArtModel.CreatedAt)
            .Set(n => n.MintedDate, NftArtModel.MintedDate)
            .Set(n => n.OneOfOne, NftArtModel.OneOfOne)
            .Set(n => n.Edition, NftArtModel.Edition)
        );
    }

    private async Task HandleOwnersValidSubmit()
    {
        await NftService.UpdateNft(new UpdateNftBuilder(DomainNft!.Id)
            .Set(n => n.Owners, NftArtModel.Owners)
        );
    }

    private void HandleMediaSubmit(NftMediaImages nftMediaImages)
    {
        NftArtModel.NftUrl = nftMediaImages.NftUrl;
        NftArtModel.OptimizedImages = nftMediaImages.OptimizedImages;
    }

    private async Task HandleExternalLinksSubmit(AvailablePurchase availablePurchase)
    {
        await NftService.UpdateNft(new UpdateNftBuilder(DomainNft!.Id)
            .Set(n => n.AvailablePurchase, availablePurchase)
        );

        NftArtModel.AvailablePurchase = availablePurchase;
    }

    private async Task HandleMintedEventValidSubmit(NftTransferEvent mintedEvent)
    {
        await NftService.UpdateNft(new UpdateNftBuilder(DomainNft!.Id)
            .Set(n => n.MintedEvent, mintedEvent)
        );
    }

    private async Task DeleteNft()
    {
        var confirmation = await dialog.ShowAsync(
            title: "Deletar NFT",
            message1: "Tem certeza que quer deletar esse NFT?");

        if (confirmation)
        {
            await NftService.DeleteNft(DomainNft!.Id);
            Navigation.NavigateTo($"/nfts");
        }
    }
}
