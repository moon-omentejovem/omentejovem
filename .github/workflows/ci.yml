name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  lint-and-type-check:
    name: ğŸ” Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ï¿½ Enable Corepack
        run: corepack enable

      - name: ï¿½ğŸ“š Install dependencies
        run: yarn install --immutable

      - name: ğŸ” ESLint
        run: yarn lint

      - name: ğŸ“ TypeScript check
        run: npx tsc --noEmit

      - name: ğŸ¨ Prettier check
        run: npx prettier --check .

  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ï¿½ Enable Corepack
        run: corepack enable

      - name: ï¿½ğŸ“š Install dependencies
        run: yarn install --immutable

      - name: ğŸ”§ Setup build environment
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=https://mock.supabase.co" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=mock-service-role-key" >> $GITHUB_ENV
          echo "ADMIN_EMAIL=admin@test.com" >> $GITHUB_ENV
          echo "SKIP_SEED=true" >> $GITHUB_ENV

      - name: ğŸ—ï¸ Build project
        run: yarn build

      - name: ğŸ“Š Bundle analysis
        run: |
          echo "Build completed successfully"
          echo "Bundle size: $(du -sh .next | cut -f1)"
          if [ -d ".next/server/app" ]; then
            echo "App Router pages generated"
          fi

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: build-${{ github.sha }}
          path: |
            .next/
            !.next/cache/
          retention-days: 3

  test-services:
    name: ğŸ§ª Test Services Pattern
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ï¿½ Enable Corepack
        run: corepack enable

      - name: ï¿½ğŸ“š Install dependencies
        run: yarn install --immutable

      - name: ğŸ” Validate Services architecture
        run: |
          echo "ğŸ” Checking Services pattern compliance..."

          # Check if Services exist and follow pattern
          if [ -d "src/services" ]; then
            echo "âœ… Services directory found"

            # Check if all services extend BaseService
            for service in src/services/*Service.ts; do
              if [ -f "$service" ] && ! grep -q "extends BaseService" "$service"; then
                echo "âŒ Service $service must extend BaseService"
                exit 1
              fi
            done
          fi

          # Check for direct Supabase client usage in components (should use Services)
          if grep -r "createClient\|supabase\." src/app/ src/components/ --include="*.ts" --include="*.tsx" | grep -v -E "(middleware|layout|api/)" | grep -v "// CI: ignore-supabase-usage"; then
            echo "âš ï¸  Direct Supabase client usage found. Consider using Services pattern."
          fi

          echo "âœ… Services architecture validation completed"

  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ï¿½ Enable Corepack
        run: corepack enable

      - name: ï¿½ğŸ“š Install dependencies
        run: yarn install --immutable

      - name: ğŸ”’ Yarn audit
        run: yarn audit --level moderate
        continue-on-error: true

      - name: ğŸ” Check for sensitive files
        run: |
          # Check for accidentally committed sensitive files
          if find . -name "*.env" -not -path "./node_modules/*" -not -name "*.env.example" | grep -q .; then
            echo "âŒ Found .env files that shouldn't be committed"
            exit 1
          fi

          if grep -r "sk_" --include="*.ts" --include="*.tsx" --include="*.js" . | grep -v node_modules | grep -v ".env.example"; then
            echo "âŒ Found potential secret keys in code"
            exit 1
          fi

          echo "âœ… Security checks passed"
