name: Security Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: ğŸ“š Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ”’ Run yarn audit
        run: |
          echo "Running security audit..."
          yarn audit --level moderate --json > audit-report.json || true

          # Check if there are any vulnerabilities
          VULNERABILITIES=$(cat audit-report.json | grep '"type":"auditSummary"' | jq '.data.vulnerabilities.total' || echo "0")

          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "âš ï¸ Found $VULNERABILITIES vulnerabilities"
            cat audit-report.json | grep '"type":"auditAdvisory"' | jq '.data' || true
          else
            echo "âœ… No vulnerabilities found"
          fi

      - name: ğŸ” Check for sensitive files
        run: |
          echo "Checking for accidentally committed sensitive files..."

          # Check for .env files (except .env.example)
          if find . -name "*.env" -not -path "./node_modules/*" -not -name "*.env.example" | grep -q .; then
            echo "âŒ Found .env files that shouldn't be committed:"
            find . -name "*.env" -not -path "./node_modules/*" -not -name "*.env.example"
            exit 1
          fi

          # Check for potential API keys or secrets
          if grep -r -E "(sk_|pk_test_|pk_live_)" --include="*.ts" --include="*.tsx" --include="*.js" . | grep -v node_modules | grep -v ".env.example"; then
            echo "âŒ Found potential API keys in code:"
            grep -r -E "(sk_|pk_test_|pk_live_)" --include="*.ts" --include="*.tsx" --include="*.js" . | grep -v node_modules | grep -v ".env.example"
            exit 1
          fi

          # Check for hardcoded passwords or tokens
          if grep -r -i -E "(password|token|secret|key)\s*[:=]\s*['\"][^'\"]+['\"]" --include="*.ts" --include="*.tsx" --include="*.js" . | grep -v node_modules | grep -v ".env.example" | grep -v "placeholder\|example\|test\|mock"; then
            echo "âš ï¸ Found potential hardcoded secrets (review manually):"
            grep -r -i -E "(password|token|secret|key)\s*[:=]\s*['\"][^'\"]+['\"]" --include="*.ts" --include="*.tsx" --include="*.js" . | grep -v node_modules | grep -v ".env.example" | grep -v "placeholder\|example\|test\|mock"
          fi

          echo "âœ… Sensitive files check completed"

      - name: ğŸ›¡ï¸ Check dependencies for known vulnerabilities
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“Š Generate security report
        run: |
          echo "# ğŸ”’ Security Audit Report" > security-report.md
          echo "" >> security-report.md
          echo "**Date:** $(date)" >> security-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-report.md
          echo "**Commit:** ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md

          echo "## Dependencies Audit" >> security-report.md
          if [ -f audit-report.json ]; then
            VULNERABILITIES=$(cat audit-report.json | grep '"type":"auditSummary"' | jq '.data.vulnerabilities.total' || echo "0")
            echo "- **Total vulnerabilities found:** $VULNERABILITIES" >> security-report.md
          else
            echo "- **Status:** âœ… No audit data available" >> security-report.md
          fi

          echo "" >> security-report.md
          echo "## File Security Check" >> security-report.md
          echo "- **Sensitive files:** âœ… No .env files found in repository" >> security-report.md
          echo "- **API keys scan:** âœ… No hardcoded keys detected" >> security-report.md

          cat security-report.md

      - name: ğŸ“¤ Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-${{ github.sha }}
          path: |
            security-report.md
            audit-report.json
          retention-days: 30

  dependency-review:
    name: ğŸ“‹ Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-ghsas: |
            GHSA-example-ghsa-id
          comment-summary-in-pr: true
